% group2.tex

\section{Splinter Group 2: Weak Lensing Holistic Forecast Definitions}

\subsection{Lensing projections}
\label{sec:WL_proj}

Starting from the Born approximation of the convergence, the exact equation for the convergence power spectrum 
with (correlated) sources in redshift bins $i$ and $j$ for a flat universe is
\begin{equation}
  P_{ij}(\ell) = \frac{9}{4} \Omega_{\rm m}^2 \left(\frac{H_0}{c}\right)^4
                \int_{0}^{\chi_{\rm lim}} \mathrm{d}\chi W_i(\chi)
                \int_{0}^{\chi^\prime_{\rm lim}} \mathrm{d}\chi^\prime W_i(\chi^\prime)
                \int_0^\infty {\rm d} k \, k^2 \, P_{\rm m}(k, \chi, \chi^\prime) \,
                {\rm j}_\ell(k \chi) \, {\rm j}_\ell(k \chi^\prime),
  \label{eq:pstomog_bessel}
\end{equation}
%
where ${\rm j}_\ell$ is the spherical Bessel function of order $\ell$,
$W_{i}(\chi)$ is the window function or \emph{lensing efficiency}.
and $\chi$ the comoving distance.
In the Limber approximation, this equation simplifies to
%
\begin{equation}
  P_{ij}(\ell) = \frac{9}{4} \Omega_{\rm m}^2 \left(\frac{H_0}{c}\right)^4 \int_{0}^{\chi_{\rm lim}}\frac{\mathrm{d}\chi}{\chi^2}
                 W_{i}(\chi) W_{j}(\chi) P_{\rm m}\left(k = \frac{\ell + 1 / 2}{ f_K(\chi)}, \chi\right),
  \label{eq:pstomog}
\end{equation}
%
This latter equation is the case of general curvature $K$, with $f_K$ the comoving angular
diameter distance.
Note that often the relation between 3D and 2D modes $k = \ell/f_K(\chi)$ is used,
which leads however to less accurate results.
%
See Sect.~\ref{sec:WL_systematics} for a discussion on the various assumptions and approximations under which this 
equation is derived.
The lensing efficiency is given as 
%
\begin{equation}
 W_i(\chi) = \int^{\chi_{\rm lim}}_\chi {\rm d} \chi^\prime \, n_i(\chi^\prime) \frac{f_K(\chi^\prime - \chi)}{f_K(\chi^\prime)}.
\end{equation}
%
The redshift distribution for bin $i$ is denoted with $n_i$, and it is normalized to
the number of galaxies belonging to that bin,
%
\begin{equation}
  \int_0^{\chi_{\rm lim}} {\rm d} \chi \, n_i(\chi) = \int_0^{z_{\rm lim}} {\rm d} z \, n_i(z) = 1.
  \label{eq:nofz_norm}
\end{equation}

\subsection{Redshift distribution}
\label{sec:WL_nofz}

The window function depends on $n_{i}(z)$, the galaxy distribution
in the $i$-th redshift bin: this is convolved with a Gaussian to account for photometric
redshift errors $\sigma_{z}$~(value specified below), i.e.~
\begin{equation}
n_{i}(z)=A \int\limits _{i\text{-th bin}}n({z^\prime})\exp\left(\frac{-(z\prime-z)^{2}}{2 \sigma_{z}^{2}}\right)\mathrm{d}{z^\prime}
\label{eq:n_binned}
\end{equation}
where the integral is done over $z^\prime$ for the single i-th bin. 
$A = \frac{1}{\sqrt{2\pi} \sigma_z}$ a normalization factor.

\subsubsection{$n(z)$}

In eq. (\ref{eq:n_binned}), we use the number density
%
\begin{equation}
n(z) = a_1\exp\left[-\frac{(z-0.7)^2}{b_1^2}\right]+c_1\exp\left[-\frac{(z-1.2)^2}{d_1^2}\right]
\label{eq:n_of_z_base}
\end{equation}
%
where $(a_1, b_1, c_1, d_1)=(1.50, 0.32, 0.20, 0.46)$. This distribution is taken from \cite{CFHTLenS-kappa-maps} and 
is a fitting function for the number density as a function of redshift for the CFHTLenS survey. This is the most applicable $n(z)$ for Euclid as 
CFHTLenS covers each of the ground based broad-band filters to the depth required for Euclid ground-based photometry. 

\tk{Need to specify the exact binning in redshift for this functional form.}

\subsubsection{p(z)}
The photometric redshift behaviour needs to be able to model the three top-level requirements for this posterior redshift estimates. These are: 
the scatter in the photometric redshifts (variance of the $p(z)$), the fraction of outliers, and any residual bias in the phototmetric redshifts. 
These three features can be captured in a double-Gaussian distribution where the functional form is a sum of the main sample and the outying sample 
\begin{equation}
p(z|z_p)=\frac{1-f_{\rm out}}{\sqrt{2\pi}\sigma_z(z_p)}\exp\left[-(z-c_{\rm cal}z_p+z_{\rm bias})^2/2\sigma_z^2(z_p)\right]+
\frac{f_{\rm out}}{\sqrt{2\pi}\sigma^O_z(z_p)}\exp\left[-(z-c^O_{\rm cal}z_p+z^O_{\rm bias})^2/2[\sigma^O_z(z_p)]^2\right], 
\label{eq:n_of_z_calib}
\end{equation} 
Here we have assumed that the photo-z distribution is calibrated, but imperfectly, so that the median spectroscopic redshift distribution 
is biased and inclined so that it lies along a line $z_s =c_{\rm cal}z_p +z_{\rm bias}$, 
where $z_{\rm bias}$ is some bias and $c_{\rm cal}$ is a calibration. 
A value $c_{\rm cal} = 1$ would mean that the photometric redshift estimation is perfectly 
calibrated to a spectroscopic sample. The redshift error $\sigma^O_z(z)$ is assumed to be unknown and the distribution is 
also assumed to lie between some photometric redshift range $z_{\rm range}$. We also assume a fraction $f_{\rm out}$ 
of outlying galaxies in the sample, inclined on a slope described by $z^O_{\rm bias}$ and $c^O_{\rm cal}$. 
The outlying sample's redshift error is range
also unknown $z^O(z)$, which is the range in photometric redshift over which the outliers subtend. 
Note that we do not include outliers that have low spectroscopic redshifts but a broad range in estimated 
photometric redshift. Our analysis may be pessimistic in this case since by 
including such a sample some redshift biasing effects may cancel-out in this analytic approximation.

\tk{Contacting OUPHZ for current best estimates.}

\subsection{Covariance matrix}
\label{sec:WL_cov}

To write down the covariance matrix, we first define the observed power spectrum \cite{1999ApJ...522L..21H} as
%
\begin{equation}
  P^{\rm obs}_{ij}(\ell) = P_{ij}(\ell) + N_{ij}(\ell),
  \label{eq:pstomog_obs}
\end{equation}
%
where the tomographic power spectrum $P_{ij}$ is given in eq.~(\ref{eq:pstomog}).
The shot noise spectrum $N_{ij}(\ell)$ contaminating $P_{ij}(\ell)$ is given by the diagonal matrix
%
\begin{equation}
N_{ij}(\ell) = \delta_{ij} \left\langle \gamma_{\mathrm{int}}^{2} \right\rangle {{{q}}_i}^{-1}
\end{equation} 
%
where $\left\langle \gamma_{\mathrm{int}}^2\right\rangle$ is the
intrinsic galaxy shear dispersion per component and 
%
\begin{equation}
q_{j} = n_\theta = \frac{n_\theta}{{\rm arcmin}^2} 3600 \left(\frac {180}{\pi}\right)^{2}.
\end{equation}
%
Here $n_{\theta}$ is the galaxy density and $n_j(z)$ is the galaxy density for the j-th redshift bin, as defined in eq.~\ref{sec:WL_nofz}).
Note that $n_j$ is normalized for every $j$ (eq.~\ref{eq:nofz_norm}).

\subsubsection{Gaussian part}

The Gaussian component of the covariance of the observed power spectrum for a shell width width $\Delta \ell$
is then according to \cite{2004MNRAS.348..897T,2008A&A...477...43J}
%
\begin{equation}
  C[P_{ij}(\ell), P_{mn}(\ell^\prime)] = \frac{2 \delta_{\ell\ell^\prime}}{(2\ell+1) \Delta \ell f_{\rm sky}}
    \left[ P^{\rm obs}_{im}(\ell) P^{\rm obs}_{jn}(\ell) + P^{\rm obs}_{in}(\ell) P^{\rm obs}_{jm}(\ell) \right],
\label{eq:pstomog_cov}
\end{equation}
%
where $f_{\rm sky} = A / (4\pi)$ is the fraction of sky observed by the survey with area $A$.
\mk{Prefactors seem to be different in Joachimi and Takada}.

\subsubsection{Non-Gaussian part}

\paragraph{Small-scale modes}

The non-Gaussian contribution consists of integrals over the convergence
trispectrum. A corresponding expression can be found in
\cite{1999ApJ...527....1S} and \cite{2004MNRAS.348..897T}.

\cite{WH00} compared Gaussian and non-Gaussian contributions, the latter from $N$-body simulation results.

\paragraph{Super-survey modes}

The above mentioned expressions for the non-Gaussian covariance as integrals
over the trispectrum do not include couplings of small-scale modes with long
wavelength modes that are larger than the observed survey volume. These
super-survey modes were first introduced as beat coupling in
\cite{2006MNRAS.371.1188H}, and also discussed in \cite{2009MNRAS.395.2065T}.

Contrary to the other terms of the covariance that scale inversely with the
survey area $f_{\rm sky}$, the super-survey covariance (SSC) decreases faster.
Therefore it is important for small survey areas \cite{2009ApJ...701..945S}. A
rigorous treatment of the non-Gaussian covariance including the SSC is
presented in \cite{2013PhRvD..87l3504T}.

\mk{TODO: summarize results from papers that quantify influence of non-Gaussian terms.}

\subsubsection{Further issues}

\paragraph{Cosmology-dependence}

\cite{2009A&A...502..721E}.


\subsubsection{Modelling methods}

The Gaussian part can be computed exactly analytically. For the non-Gaussian contribution,
modelling options are as follows.

\begin{itemize}

\item Halo model. The trispectrum has been approximated by various authors
using the halo model. \cite{2009MNRAS.395.2065T} only take into consideration
the one-halo term and the perturbation-theory term. The former is the dominant
contribution in the highly non-linear regime on sub-halo scales. The latter
appxorimates the contribution from different halos (2-, 3-, 4-halo terms) on
intermediate scales. On large scales the non-Gaussian errors are sub-dominant
compared to the Gaussian errors.

All four halo terms for the trispectrum were computed in
\cite{2001ApJ...554...56C}, and compared to $N$-body simulations.

Super-survey modes were modeled in the halo model framework as ``halo sample
variance'' (HSV; \cite{2009ApJ...701..945S}, \cite{2013MNRAS.429..344K}.


\item Fitting formulae.

Fitting formulae for the non-Gaussian cosmic variance of the power spectrum have been provided
by \cite{2010A&A...514A..79P}. Corresponding expressions for the real-space correlation function
are published in \cite{2011ApJ...734...76S}.

\item $N$-body simulations.

DEUS.

The SSC in numerical simulations were studied in detail 
in \cite{2014PhRvD..89h3519L}.



\end{itemize}

\cite{2013MNRAS.429..344K} only account for the 1-halo term and HSV for the
covariance. \cite{2013arXiv1302.2401E} compute the full covariance in the halo
model accounting for all four halo terms and HSV.

\mk{Todo: look for analytical approaches (renormalization approach)}


\subsection{Fisher matrix}

The Fisher matrix is summed over all multiples:
%
\begin{equation}
F_{\alpha\beta}=f_{\mathrm{sky}}\sum\limits _{\ell,i,j,k,m}\frac{(2\ell+1)\Delta\ell}{2}\frac{\partial P_{ij}(\ell)}{\partial\theta_{\alpha}}C_{jk}^{-1}\frac{\partial P_{km}(\ell)}{\partial\theta_{\beta}}C_{mi}^{-1}\label{eq:fm-wl}.
\end{equation}

\mk{This term of the Fisher matrix is the one used in Hu 1999, using \ref{eq:pstomog} diretcly as covariance.
Using \ref{eq:pstomog_cov} the other Fisher-matrix term is used in Takada\&Jain. Check whether both are consistent.}

\subsection{Likelihood function}

For an ideal full-sky experiment, the likelihood of the observed spectra given the theoretical spectra reads
\begin{equation}
\mathcal L = \mathcal N \Pi_{\ell, m} \left\{ \frac{1}{ (d_{\ell}^{\rm th} )^{1/2} } \exp \left[ - \frac 1 2 a_{\ell m}^{{\rm obs} \dagger} (\tilde C_l^{\rm th})^{-1} a_{\ell m}^{\rm obs}  \right]     \right\}~,
\end{equation}
where $\mathcal N$ is a normalization factor.   The likelihood simplifies to
\begin{equation}
\mathcal L = \mathcal N \Pi_{\ell, m} \left\{ \frac{1} { (d_{\ell}^{\rm th} )^{1/2} }  \exp \left[ - \frac 1 2 (2 \ell +1) \frac{d_\ell ^{\rm mix } } { d_\ell ^{\rm th}}      \right]     \right\}~,
\end{equation}
where 
\begin{equation}
d_\ell ^{\rm th} = {\rm det } \left[ C_{ij}^{\rm th} (\ell) \right]
\end{equation}
\begin{equation}
d_\ell ^{\rm obs} = {\rm det } \left[ C_{ij}^{\rm obs} (\ell) \right]
\end{equation}
and $ d_\ell ^{\rm mix} $ is a quantity obtained by replacing one after each other the theoretical spectra $C_{ij}^{\rm th} (\ell) $ by the observed ones $C_{ij}^{\rm th} (\ell) $ (see~\cite{Audren:2012vy} for details and an exemple).  

By using a first-order approximation to take into account the limited sky coverage, the $\chi^2$ relative to the best-fit model is given by~\cite{Audren:2012vy}
\begin{equation}
\Delta \chi_{\rm eff} ^2 \equiv  -2 \ln \frac{\mathcal L}{\mathcal L_{\rm max}} \equiv \sum_\ell (2 \ell + 1) f_{\rm sky} \left( \frac{d_\ell ^{\rm mix}}{d_\ell ^{\rm th}}  + \ln \frac{d_\ell ^{\rm th}}{d_\ell ^{\rm obs}} - \mathcal N \right)
\end{equation}
which should be used in MCMC forecast codes. 


\subsection{Weak lensing code comparison}


\subsection*{WL comparison: where to start} 

The Euclid baseline survey has the following specifications.
%
\begin{enumerate}
\item Area: $A = 15,000$ sq deg
\item Corresponding sky fraction $f_{sky} = A/(4 \pi (180/\pi)^2)$
\item Redshift distribution eq.~\ref{eq:n_of_z_base}
\item Median Redshift: $z_{\rm m} = 0.9$
\item Intrinsic ellipticity dispersion per component: $\gamma_{\mathrm{int}}=0.22$
\item Galaxy density $n_\theta = 30 \mathrm{arcmin}^{2}$
\item Error on photometric redshift: $\sigma_z = 0.05 (1+z)$
\item Fracion of catastrophic outliers: $f_{\rm out} = 0.1$
\item Redshift binning: 10 bins from z = 0 - 2.5 such that bins contain equal numbers of galaxies
\end{enumerate}

Further choices are

\begin{enumerate}
\item Non-linearities: \cite{Mead15}
\item k-range: $k_{min}=0.001 h/$Mpc, \revtext{$k_{max}=10 h/$Mpc}.
    At small scales ($k>1$-$5h/$Mpc) the tolerance for code comparison can be larger than on small scales, since we will be dominated by
    uncertain physics.
\item $\ell$-range: $\ell_{min}=5$, $\ell_{max}$ \revtext{fixed as a function of z, using the table provided by Enea (uploaded in the wiki). No cut in z.}
\item $\ell$-binning: 100 bins (with log spaced binning)
\end{enumerate}

The following tables defines baselines of increasing complexity for the various WL inputs.
The items are listed in each table with increasing complexity, either from a coding point of view or physical complexity.
The asterisk $^\ast$ denotes the minimum requirement item needed for a relatively realistic Fisher matrix forecast for Euclid.
For items with higher complexity it is not clear (yer) whether they have a significant influence of the prediction results.

\begin{table}
Matter power spectrum (see Sect.\ref{sec:WL_NL_power}).

\begin{tabular}{ll} \hline\hline
pk-1 & linear, CDM, GR \\
pk-2 & linear CDM + HDM (light neutrinos), GR \\
pk-3 & Including non-linear power \\
pk-4$^\ast$ & Including baryonic corrections \\
pk-5$^{(\ast)}$ & Including WDM (massive neutrinos) \\
pk-6 & non-GR models \\
\hline\hline
\end{tabular}

\cite{Mead15,Mead16} is one of the most recent and accurate choices for (2), and seems to comply to a large part
with options (3)-(5) as well.
\bigskip \bigskip


Redshift distribution $n(z)$ (see Sect.~\ref{sec:WL_nofz}).

\begin{tabular}{ll} \hline\hline
nz-1 & perfectly known, no photo-$z$ errors \\
nz-2 & Including dispersion $\sigma_z$, eq.~(\ref{eq:n_binned}) \\
nz-3$^\ast$ & With catastrophic outliers $f_{\rm out}$, calibration $c_{\rm cal}$ and biases $z_{\rm bias}$, eq.~(\ref{eq:n_of_z_calib}) \\
\hline\hline
\end{tabular}
\bigskip \bigskip

Intrinsic alignment (see Sect.~\ref{sec:WL_IA}).

\begin{tabular}{ll} \hline\hline
ia-1  & no IA \\
ia-2a$^\ast$ & linear IA model \`a la \cite{2004PhRvD..70f3526H,2007NJPh....9..444B,2011A&A...527A..26J} \\
ia-2b & linear+quadratic alignment models, e.g.~\cite{2013MNRAS.435..194C} \\
\hline\hline
\end{tabular}
\bigskip \bigskip

Covariance matrix (see Sect.~\ref{sec:WL_cov}).

\begin{tabular}{ll} \hline\hline
cm-1$^\ast$ & Gaussian cosmic variance (analytical) \\
cm-2 & Including non-Gaussian trispectrum terms \\
cm-3 & Including non-Gaussian super-survey terms \\
\hline\hline
\end{tabular}
\bigskip \bigskip

Lensing projections (see Sect.~\ref{sec:WL_proj})

\begin{tabular}{ll} \hline\hline
lp-1$^\ast$ & Born, Limber, no clustering, shear \\
lp-2 & Including source clustering \\
lp-3 & reduced shear, beyond Limber and Born \\
lp-4 & Relativistic effects, peculiar motions, other exotic higher-order effects \\
\hline\hline
\end{tabular}
\bigskip \bigskip

Observable

\begin{tabular}{ll} \hline\hline
ob-1  & idealistic power spectrum \\
ob-2a$^\ast$ & observed power spectrum (including window and mask effects) \\
ob-2b$^\ast$ & correlation function \\
\hline\hline
\end{tabular}
\bigskip \bigskip


\end{table}

\subsection*{WL case 1: minimal setting}

\begin{enumerate}
\setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}
\item pk-1, linear power spectrum
\item nz-1, no redshift errors
\item ia-1, no intrinsic alignment
\item cm-1, Gaussian covariance
\item lp-1, Born, Limber, no clustering
\item ob-1, idealistic power spectrum
\end{enumerate}

\subsection*{WL case 2: with non-linear corrections and photo-$z$ errors}

\begin{enumerate}
\setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}
\item pk-2, non-linear power spectrum
\item nz-2, $n(z)$ with dispersion
\item ia-1, no IA
\item cm-1, Gaussian covariance
\item lp-1, Born, Limber, no clustering
\item ob-1, idealistic power spectrum
\end{enumerate}

\subsection*{WL case 3: including intrinsic alignment, realistic photo-$z$ errors}

\begin{enumerate}
\setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}
\item pk-3, non-linear power spectrum
\item nz-3, with catastrophic outliers, biases
\item ia-2, linear IA model
\item cm-1, Gaussian covariance
\item lp-1, Born, Limber no clustering
\item ob-1, idealistic power spectrum
\end{enumerate}

\subsection*{WL Case 4: realistic observables, baryonic effects}

\begin{enumerate}
\setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}
\item pk-4, baryonic corrections
\item nz-3, with catastrophic outliers, biases
\item ia-2, linear IA model
\item cm-1, Gaussian covariance
\item lp-1, Born, Limber no clustering
\item ob-1, observaed power spectrum or correlation function
\end{enumerate}


\subsection*{WL Case 5 and beyond:  extended cases (to be considered in a second phase?) }  

(to be further discussed)


\subsection{Real-space forecasts}

The numerical calculation of real-space quantities is straight-forward,
accurate, and fast. All real-space functions can be represented as  1D
integrals over the filtered convergence-power spectrum $P_\kappa = P_\kappa^{\rm E} + P_\kappa^{\rm B}$.
For the 2PCF $\xi_+$
and $\xi_-$, these are efficiently carried out as Hankel transformation,
%
\begin{align}
  \xi_+(\theta) & = \frac 1 {2\pi} \int {\rm d} \ell \, \ell {\rm J}_0(\ell
   \theta)
  [ P_\kappa^{\rm E}(\ell) + P_\kappa^{\rm B}(\ell)];
  \nonumber \\
   %
   \xi_-(\theta) & = \frac 1 {2\pi} \int
   {\rm d} \ell \, \ell {\rm J}_4(\ell \theta)
  [ P_\kappa^{\rm E}(\ell) - P_\kappa^{\rm B}(\ell) ].
  %
   \label{eq:xi_pm_pkappa}
\end{align}
%
For COSEBIs, the aperture-mass dispersion, and other real-space functions, the
filter functions are smooth and have none to relatively few oscillations.
The general expression for an E-/B-mode separating function $X_{\rm E, B}$ is
%
\begin{equation}
  X_{\rm E, B} = \frac 1 {2\pi} \int_0^\infty {\rm d} \ell \, \ell \, P_\kappa^{\rm E, B}(\ell) \fourier U^2(\ell) .
  %
  \label{eq:X_EB_Fourier}
\end{equation}
%
Fast
and acurate codes exist to carry out the integrals in (\ref{eq:xi_pm_pkappa}) and (\ref{eq:X_EB_Fourier})
(\texttt{FFTLog} \cite{2000MNRAS.312..257H};
\texttt{nicaea}, part of \texttt{CosmoPMC} \cite{cosmo_pmc_ascl}; non-public
codes from Patrick Simon, Marika Asgari).

Some of these transformations are valid for a flat sky, and we need to check
their accuracy for the curved sky case, and potentially modify those
tranformations if necessary.

The covariance matrix for real-space functions often shows stronger
off-diagonal parts than the power spectrum. The latter, in the ideal case of a
Gaussian shear field on the full sky, has zero-off diagonal elements. However,
the non-Gaussian LSS on small scales and mask effects introduce off-diagonal
correlations. In fact, the relation between the observable (band-power)
spectrum and the underlying true convergence power spectrum $P_\kappa$ has the
same form (\ref{eq:X_EB_Fourier}) as the relation between a real-space function
and $P_\kappa$. The amplitude of off-diagonal elements depends mainly on the
width of the filter function.

$\xi_+$ and $\xi_-$ have a covariance with very large off-diagonal elements.
The calculation of the cosmic variance term even in the Gaussian case is
time-consuming due to the product of two Bessel function with different
arguments $\ell \theta_i$, $\ell \theta_j$ for the off-diagonal element
$C_{ij}$ with $i \ne j$. A code exists (Benjamin Joachimi) that has been used
within Euclid. Even with parallelization on ${\cal O}(50)$ CPUs, 
for $N_\theta = 50$ and $N_z = 12$ it takes a up to two weeks to compute
the $N_\theta^2 [N_z (N_z + 1)] / 2 \times 4$ covariance elements for $\xi_+$ and $\xi_-$
including the mixed terms ($+-, -+)$. The corresponding expressions for this covariance
can be found in \cite{2008A&A...477...43J}.

Fitting formulae for the non-Gaussian covariance for $\xi_+$ and $\xi_-$ have been published in
\cite{2007MNRAS.375L...6S} and, more recently in \cite{2011ApJ...734...76S}.



\subsection{Systematics: overview}
\label{sec:WL_systematics}

Often for Fisher matrix forecast, we implicitly assume that the observed power spectra
is an unbiased realization of the underlying theoretical one so that we can
directly compare them to infer constraints on the cosmological parameters.
Actually, systematics make this assumption less than obvious. Roughly speaking,
we can divide systematics sources in three classes.

\begin{itemize}

\item{\it Astrophysical/theoretical systematics.} This includes all those
lensing-related effects which are usually taken for granted and neglected in the standard
analysis. These are listed in Sect.~\ref{sec:lensing_systematics}, with the exception
of intrinsic aligment (IA). As one of the dominant contaminations of the lensing signal,
IA is discussed in the separated Section \ref{sec:WL_IA}.

\item{{\it Instrumental systematics.} Textbook example is CTI correction which
introduces an artificial distortion pattern which impacts the ellipticity of
each galaxy and hence the shear determination. As a result, a fake correlation
can be induced leading to a biased observed power spectrum.} \\

\item{{\it Observational systematics.} These are related to errors in the
measurement process. The most well known case concerns shape measurement codes.
In a first good approximation, one can assume that the measured ellipticity
$\epsilon_{obs}$ is related to the true one $\epsilon$ as $\epsilon_{obs} = (1
+ m) \epsilon + c$, with $(m, c)$ the multiplicative and additive bias
respectively. Depending on the code, $(m, c)$ can depend on the galaxy
properties; e.g.~\cite{CFHTLenS-shapes} have used mock CFHTLenS data analysed
with the {\it lensfit} code to show that, while $c$ is negligible, $m$ is a
function of the galaxy size and S/N ratio. As a second example, one can
consider colour gradient bias which can still be parameterized with the same
formalism with $m$ dependent on the source redshift and color as preliminarily
found by \cite{2013MNRAS.432.2385S}.}

\end{itemize}

The impact of systematics in the first class can be explicitely evaluated and their impact on the cosmic shear power spectrum quantified and included if necessary. On the contrary, second and third class systematics ask for a more empirical analysis. Under general assumptions, we can model their impact stating that the following relation hold

\begin{displaymath}
{\cal{C}}_{sys}(\ell, z_i, z_j) = (1 + {\cal{M}}_{ij}) {\cal{C}}_{lens}(\ell, z_i, z_j) + {\cal{A}}(\ell, z_i, z_j)
\end{displaymath}
where ${\cal{C}}_{sys}$ and ${\cal{C}}_{lens}$ are the cosmic shear power spectra with systematics included and the theoretical one, ${\cal{M}}_{ij}$ a redshift dependent multiplicative correction and ${\cal{A}}(\ell, z_i, z_j)$ is a scale and redshift dependent additive correction.

Forecasting codes should include the relevant astrophysical systematics as a
first step. A parameterization for the multiplicative and additive bias terms
should be worked out to be added as soon as second and third class systematics
have been quantified in some way.


\cite{Audren:2012vy} (App.~B4) propose a global uncorrelated theoretical error to be included as nuisance parameter in the covariance matrix.


% -------------------------------------------------------------------- %
\subsection{Systematics: astrophysical}
\label{sec:lensing_systematics}

Weak lensing probes the cosmic large-scale structure through its null-geodesics: While this property follows almost universally from all relativistic theories of gravity and is easy enough to understand, the technical computation of weak lensing observables, in particular on small scales, is challenging as it is influenced by a number of second-order effects. With Euclid, large multipoles are probed with high statistical precision such that the exact prediction of spectra on small scales is necessary in order to have unbiased measurements: Euclid's weak lensing data set will have a statistical significance of about $10^3\sigma$, such that for example an over- or underpredicition of the spectra by $10^{-3}$ will be a $1\sigma$-bias.

Second order effects in weak lensing fall into a couple of categories, according to the physical mechanisms, but they have in common that the weak lensing signal is weighted by a second field, which, under some circumstances, can generate $B$-modes in the ellipticity field - with impact on the calibration of the ellipticity measurements. Typically, the effects are important on small scales around and above $\ell=10^3$ and modify the spectra by a factor of $10^{-3\ldots-8}$ depending on the nature of the weighting field.

\subsubsection{description of fluctuations}

Several approximations are usually made, and should be examined, to describe
density flucutations, their correlations, and their projections. The Limber
approximation (eq.~\ref{eq:pstomog}, see
\cite{1953ApJ...117..134L,1992ApJ...388..272K}) assumes that the power spectrum
is slowly varying compared to the spherical Bessel functions in
(eq.~\ref{eq:pstomog_bessel}). In this approximation, correlations of modes
between different comoving distances are neglected. (This is also explicitely
assumed when deriving the deflection angle by linearly summing up
contributions from isolated thin lenses along the line of sight
\cite{1994CQGra..11.2345S}. This is a very good approximation of the exact convergence
power spectrum for small angles up to 10 degrees, or $\ell > 20$.

\subsubsection{geodesic effects}

The implict lens equation is solved by a perturbative expansion, where the weak
lensing deflection is collected by integration along a straight line replacing
the actual light path. At higher order, there are corrections due to better
approximations of the actual light path (Born-corrections). Similarly, the
change in shape of a light bundle is computed relative to a light bundle with
circular cross section, and corrected at higher order by gravitational
distortion of an already deformed bundle (lens-lens coupling).


\subsubsection{clustering effects}
The weak lensing effect assumes a uniform sampling of the tidal fields generated by the cosmic large-scale structure. The source galaxies, however, are clustered due to structure formation and introduce a weighting into the weak lensing  signal which reflects their angular clustering (source-source clustering; \cite{2002A&A...389..729S}). In addition, there is a positive correlation between lensing structures and structures hosting lensed galaxies (source-lens clustering; \cite{1998A&A...338..375B}), again breaking the uniform sampling in the idealised picture.


\subsubsection{relativistic effects}
Weak lensing is computed in the limit of a weakly perturbed FLRW-metric with gradients in the potential being responsible for deflection and tidal shear fields for shape distortions of galaxies. There are, however, corrections to the metric of order $\Phi/c^2$ as well as corrections due to the momentum density. In general, these effects are small but might be relevant looking for deviations from general relativity as the theory of gravity.


\subsubsection{source motion and location}
Lensing requires the conversion from the observed redshift of a source galaxy to comoving distance, and in this conversion one usually assumes that the redshift is purely cosmological. But there can be non-cosmological contributions to the redshift, for instance by peculiar motion, or by gravitational redshifting at the source itself (Sachs-Wolfe-type corrections) or by cumulative gravitational redshifting between the source and the observer (integrated Sachs-Wolfe-type corrections).

\subsubsection{lensing-specific effects}
The quantity relevant for mapping the ellipticity of a galaxy is the reduced shear $g = \gamma/(1-\kappa)$ instead of the lensing shear $\gamma$, implying corrections to the weak lensing shear spectra at second order. Furthermore, the survey depth and the number of observed galaxies is modulated by weak lensing magnification, both leading to a weighting of the shear signal with another lensing quantity (magnification bias; \cite{2001MNRAS.326..326H}.

\subsubsection{General remarks}

As a general observation we emphasise that the corrections affect higher-order statistical measures, in particular the bispectrum, at a lower order in perturbation theory.

Useful references that compile, compare, and discuss various lensing-related systematics are \cite{2010A&A...523A..28K}
and \cite{2010PhRvD..81h3002B}.



% -------------------------------------------------------------------- %
\subsection{Systematics: Intrinsic alignments}
\label{sec:WL_IA}

Weak lensing commonly operates under the assumption that ellipticities are intrinsically uncorrelated, and that weak lensing is the only effect that generates ellipticity correlations due to correlated tidal shear fields between light bundles. Galaxies can have intrinsically correlated shape due to their formation history or due to their interaction with the cosmic large-scale structure. While the exact mechanisms are not yet fully understood, there are two types of interaction based on tidal fields which are thought to be relevant for the alignment of spiral and elliptical galaxies.

\subsubsection{linear alignment model for elliptical galaxies}
The dynamical model of elliptical galaxies is that of a cloud of stars in virial equilibirum inside the hosting dark matter structure. The gravitational potential of this structure can be perturbed by tidal gravitational fields, which cause a change in shape of the stellar component. 


\subsubsection{quadratic alignment model for spiral galaxies}
The shape of a spiral galaxy is determined by the inclination angle under which we see the stellar disc. One assumes that the symmetry axis of the stellar disc coincides with the angular momentum direction of the host halo, which in turn is determined in its formation process through tidal torquing.



% -------------------------------------------------------------------- %
\subsection{Non-linear power spectrum and baryonic corrections}
\label{sec:WL_NL_power}

Weak lensing measures the projected 3D density distribution probing therefore the matter power spectrum $P(k)$ and the gravitational theory determining it. While the perturbation theory efficiently works at computing $P(k)$ in the linear regime, corrections are needed to take into account deviations on scales where the condition $\delta \rho/\rho << 1$ does not hold anymore. Moreover, on small scales, baryons collapse to form the visible structures we observe. Both nonlinearities and baryon collapse make the power spectrum $P(k)$ to differ from the linear one $P_{lin}(k)$. Different methods, tailored on N\,-\,body simulations, have been developed to phenomenologically model these corrections with the Halofit approach \cite{HaloFit}, in its updated version \cite{Taka,Bird_Viel_Haehnelt_2012}, being the most used one .  

Recently, Mead et al. \cite{Mead15,Mead16} developed a more accurate method based on a combination of the halo model approach \cite{Sel00,PS00,CS02} and tuning to power spectra from the COSMIC EMU simulations \cite{Heit10,Heit14}. We summarize below the main formulae referring the reader to the original papers for more details. Rather than $P(k)$ itself, it is more convenient to estimate the equivalent quantity

\begin{displaymath}
\Delta^2(k) = 4 \pi V \left ( \frac{k}{2 \pi} \right )^3 P(k)
\end{displaymath}
representing the fractional contribution to the variance per logarithmic interval in $k$ with $V$ the periodic volume. Following the standard halo model approach, we write $\Delta^2(k)$ as the sum of the one halo and two halo terms. The first reads

\begin{equation}
\Delta_{1H}^2(k) = 4 \pi \left ( \frac{k}{2 \pi} \right )^{3} \frac{1}{\bar{\rho}^2} \int_{0}^{\infty}{M^2 W^2(\nu^\eta k, M) n(M, z) dM} 
\label{eq: delta1h}
\end{equation}
where $\bar{\rho}$ is the mean matter density. Let us detail the different quantities entering Eq.(\ref{eq: delta1h}). First, we have the normalized Fourier transform of the halo density profile given by

\begin{equation}
W(k, M) = \frac{1}{M} \int_{0}^{R_v}{\frac{\sin{(kr)}}{kr} 4 \pi r^2 \rho_{h}(r, M) dr}
\label{eq: fthalo}
\end{equation}
where the mass $M$ and the virial radius $R_v$ are related as

\begin{equation}
R_v = \left [ \frac{3M}{4 \pi \Delta_v(z) \bar{\rho}} \right ]^{1/3}
\label{eq: rvm}
\end{equation}
with $\Delta_v(z) = 418 [\Omega_M(z)]^{-0.352}$. In order to compute $W(k, M)$, one needs to choose a model for the halo density profile. On the scales of interest, the NFW profile \cite{NFW96,NFW97} is the common choice with 

\begin{equation}
\rho_h(r) = \frac{\rho_M}{(r/R_s) ( 1+ r/R_s)^2}
\label{eq: nfw}
\end{equation}
with $\rho_M$ a normalization constant set so that the mass within $R_v$ is the the virial mass $M$ and the scale radius $R_s$ given by $R_s = R_v/c_v$. The concentration $c_v$ is related to the halo mass as

\begin{equation}
c_v = A_v \frac{1 + z_f(M)}{1 + z}  \left [ \frac{g(z \rightarrow \infty)}{g_{\Lambda}(z \rightarrow \infty)} \right ]^{1.5}
\label{eq: mcrelation}
\end{equation}
with $A_v$ a scaling constant and $g(z)$ the linear growth factor. Eq.(\ref{eq: mcrelation}) generalizes the Bullock et al. (2001) relation introducing a correction term to account for deviations from the $\Lambda$CDM model as proposed in \cite{Dol04}. The formation redshift $z_f$ is a function of the virial mass $M$ and is estimated solving

\begin{equation}
\frac{g[z_f(M)]}{g(z)} \sigma(f_v M, z) = \delta_c
\label{eq: zfsolve}
\end{equation}
where $f_v$ is a constant and $\sigma(M, z)$ is the variance of the linear density field smoothed over a top hat filter with aperture $R = (3M/4\pi \bar{\rho})^{1/3}$, namely

\begin{equation}
\sigma^2(M, z) = \int_{0}^{\infty}{\Delta_{lin}^2(k) {\cal{T}}^2(kR) d\ln{k}}
\label{eq: defsigma}
\end{equation}
with ${\cal{T}}(x) = 3(\sin{x} - x \cos{x})/x^3$. Note that $\sigma(M, z) = g(z) \sigma(M, z = 0)$ because of the linear regime. In Eq.(\ref{eq: zfsolve}), $\delta_c$ is the critical overdensity for spherical collapse. This is usually fixed to the canonical value $\delta_c = 1.686$, but it has been found that a better agreement with simulations can be obtained taking \cite{NS97}

\begin{equation}
\delta_c(z) = [1.59 + 0.0314 \ln{\sigma_8(z)}]  \times [1 + 0.0123 \ln{\Omega_M(z)}]
\label{eq: deltac}
\end{equation}
with $\sigma_8(z) = \sigma_8 g(z)$ and $\sigma_8$ the present day variance on scale $R = 8 h^{-1} \ {\rm Mpc}$.  

The last ingredient needed to compute the one halo term in Eq.(\ref{eq: delta1h}) is the halo mass function, i.e., the number of halo with mass in the range $(M, M + dM)$ in the unit voume. Following \cite{ST99}, it is 

\begin{equation}
n(\nu) = A_{MF} \left [ 1 + \frac{1}{(a_{MF} \nu^2)^p} \right ] \exp{(-a_{MF} \nu^2/2)}
\label{eq: stmf}
\end{equation}
with $A_{MF} = 0.2162$, $a_{MF} = 0.707$, $p = 0.3$ and $\nu = \delta_c(z)/\sigma(M, z)$. Note that $\nu$ also enters Eq.(\ref{eq: delta1h}) through the normalized Fourier transfrom term $W^2(k, M)$ which is evaluated not in $k$, but in $k^{\prime} = \nu^\eta k$ with $\eta = 0.603 - 0.3 \sigma_8(z)$.  

On the large scales, haloes are no more Poisson distributed and displacements between haloes must be accounted for introducing the two halo term $\Delta_{2H}(k)$. For matter perturbations, this can be straightforwardly evaluated since it is simply

\begin{equation}
\Delta_{2H}^2(k) = \Delta_{lin}^2(k) 
\label{eq: delta2h}
\end{equation}
so that one only needs the linear power spectrum. The total power spectrum should now be estimated as the sum of the two terms, but Mead et al. \cite{Mead15} have found that a much better agreement with simulations is obtained setting

\begin{equation}
\Delta^2(k) = \left [ (\Delta_{1H}^{\prime 2})^\alpha + (\Delta_{2H}^{\prime 2})^\alpha \right ]^{1/\alpha}
\label{eq: enddelta}
\end{equation}
where the primed spectra are given by

\begin{equation}
\Delta_{1H}^{\prime 2}(k) = \left \{ 1 - \exp{[(-k/k_{\star})^2]} \right \} \Delta_{1H}^{2}(k) \ , 
\label{eq: delta1hprime}
\end{equation}

\begin{equation}
\Delta_{2H}^{\prime 2}(k) = \left [ 1 - f_{2H} \tanh^2{(k \sigma_v/\sqrt{f_{2H}})} \right ] \Delta_{2H}^2(k) \ ,
\label{eq: delta2hprime}
\end{equation}
while $(\alpha, k_{\star}, f_{2H})$ are fitted to the simulations to get \cite{Mead16}

\begin{equation}
\alpha(z) = 3.24 \times 1.85^{n_{eff}(z)} \ ,
\label{eq: alpha}
\end{equation}

\begin{equation}
k_{\star}(z) = 0.584/\sigma_v(z) \ , 
\label{eq: kstar}
\end{equation}

\begin{equation}
f_{2H}(z) = 0.0095 \ \sigma_{100}^{1.37}(z) \ .
\label{eq: f2h}
\end{equation} 
Here, we have defined the following auxiliary functions

\begin{equation}
n_{eff}(z) = - 3 - \left . \frac{d\ln{\sigma^2(R, z)}}{d\ln{R}}\right |_{\sigma = 1} \ , 
\label{eq: neff}
\end{equation}

\begin{equation}
\sigma_v^2(R, z) = \frac{1}{3} \int_{0}^{\infty}{\frac{\Delta_{lin}^2(k, z)}{k^2} {\cal{T}}^2(kR) d\ln{k}}
\label{eq: sigmav}
\end{equation}

\begin{equation}
\sigma_{100}(z) = \sigma_v(R = 100 h^{-1} \ {\rm Mpc}, z) \ . 
\label{eq: sigma100}
\end{equation}

It is worth noting that a code to calclulate the power spectra implementing all
the above formulae is available\footnote{{\tt
https://github.com/alexander-mead/hmcode}}. Originally conceived to fit the
$\Lambda$CDM power spectrum taking care of nonlinearities and baryonic effects.
However, it has been shown to work fine also for quintessence models with a
CPL\,-\,like equation of state. Moreover, it can be easily extedend to models
with modified gravity provided some fitting functions are
accordingly changed (see \cite{Mead16} for the corresponding formulae).

Neutrino corrections have been published in \cite{Bird_Viel_Haehnelt_2012}, which have been implemented in \texttt{camb}.
A simple formula to approximate these corrections is shown in \cite{2015JCAP...07..043C}.
Further models including neutrino fitting formulae are \cite{Mead16} and \cite{2012ApJ...761..152T} (Eqs.~(A6-A14)).



%\subsubsection{Baryonic corrections}


%\subsection{Fisher matrix}
%
%Then the Fisher matrix is summed over all multiples:
%\begin{equation}
%F_{\alpha\beta}=f_{\mathrm{sky}}\sum\limits _{\ell,i,j,k,m}\frac{(2\ell+1)\Delta\ell}{2}\frac{\partial P_{ij}(\ell)}{\partial\theta_{\alpha}}C_{jk}^{-1}\frac{\partial P_{km}(\ell)}{\partial\theta_{\beta}}C_{mi}^{-1}\label{eq:fm-wl}
%\end{equation}
% with the covariance matrix 
%\begin{equation}
%C_{jk}=P_{jk}+\delta_{jk}\gamma_{\mathrm{int}}^{2}{{{q}}_j}^{-1},
%\end{equation}
% where $\gamma_{\mathrm{int}}$ is the
%intrinsic galaxy shear  and 
%\begin{equation}
%q_{j} = 3600\left(\frac{180}{\pi}\right)^{2} n_{\theta} \int^\infty_0 n_j(z) dz \, .
%\end{equation}
%Here $n_{\theta}$ is the galaxy density per $\mathrm{arcmin}^{2}$ and $n_j(z)$ is the galaxy density for the j-th redshift bin, as defined in eq.(\ref{eq:n_binned}).

%Since we consider multipoles up to $\ell_{\mathrm{max}}=5000$,
%we need to apply non-linear corrections to the matter power spectrum,
%for which we use the halofit (provided in the input spectra).

%\paragraph{Specifications for the weak lensing:}
%\begin{enumerate}
%\item Area: 15,000 sq deg
%\item $f_{sky} = Area/(4 \pi (180/\pi)^2)$
%\item Median Redshift: $z_{mean} = 0.9$
%\item $\gamma_{\mathrm{int}}=0.22$
%\item $n_\theta =$ 30 galaxies per $\mathrm{arcmin}^{2}$
%\item Error on photometric redshift: $\sigma_z$ = 0.05 (1+z)
%\item Linear Power Spectrum: CAMB (provided in the input, you shouldn't use it)
%\item Method to correct for non-linearities: Halo model  (however the input files are now linear; it does not matter for now as we are not looking for the correct Fisher, just comparing. For this comparison we are using linear spectra).
%\item Binning: 10 bins from z = 0 - 2.5. We assume equipopulated bins: the redshift bins chosen such that each contain
%the same amount of galaxies. \comment{need to add formula}
%\item k-range: $k_{min}=0.001$ h/Mpc, \revtext{$k_{max}=0.5$ h/Mpc}
%\item k-binning: use directly the one provided in the input
%\item $\ell$-range: $\ell_{min}=5$, $\ell_{max}$ \revtext{fixed as a function of z, using the table provided by Enea (uploaded in the wiki). No cut in z.}
%\item $\ell$-binning: 100 bins (with log spaced binning)
%\end{enumerate}


